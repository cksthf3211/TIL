# Data base
## CASE
- 특정 상황에서 데이터를 변환하여 활용 할 수 있음
- ELSE를 생략하는 경우 NULL값이 지정됨
```sql
CASE
    WHEN 조건식 THEN 식 -- when then
    WHEN 조건식 THEN 식 
    ELSE 식             -- else
END
```
```sql
select
    id,
    case
        when gender = 1 then '남자'
        then gender = 2 then '여자'
        end as 성별
from healthcare
limit 5
;
```
```sql
select distinct smoking
from healthcare
;
--
select
    id,
    smoking,
    case
        when smoking = 1 then '비흡연자'
        when smoking = 2 then '흡연자'
        when smoking = 3 then '해비스모커'
        else '무응답'
    end
from healthcare
limit 50
;
```
```sql
select
    first_name,
    last_name,
    case
        when age <= 18 then '청소년'
        when age <= 40 then '청년'
        when age <= 90 then '중장년'
        else '중장년'
    end
from users
limit 10
;
```

## 서브쿼리
- 서브쿼리는 특정한 값을 메인 쿼리에 반환하여 활용하는 것
- 실제 테이블에 없는 기준을 이용한 검색이 가능함
- 서브쿼리는 소괄호로 감싸서 사용하며, 메인쿼리의 칼럼을 모두 사용할 수 있음
- 메인쿼리는 서브쿼리의 칼럼을 이용할 수 업음
```sql
select *
from 테이블
where 컬럼1 = (
    select 컬럼1
    from 테이블
);
```
- 단일행 서브쿼리
    - 서브쿼리의 결과가 0 또는 1개인 경우
    - 단일행 비교 연산자와 함께 사용 +, <, <=, >=, >, <>
- 다중행 서브쿼리
    - 서브쿼리 결과가 2개 이상인 경우
    - 다중행 비교 연산자와 함께 사용(IN, EXISTS 등)
- 다중컬럼 서브쿼리

- 서브쿼리
```sql
selct min(age)
from users;
```
- 메인쿼리
```sql
selct count(*)
from users
where age == (select min(age) from users);
```

```sql
-- 평균 계좌 잔고 높은 사람의 수?
SELECT COUNT(*) FROM users WHERE balance > (SELECT AVG(balance) FROM users);
```
```sql
-- 유은정과 같은 지역에 사는 사람의 수?
SELECT COUNT(*) FROM users WHERE country = (SELECT country FROM users WHERE last_name ='유' first_name='은정');
```
```sql
-- 전체 인원과 평균 연봉, 평균 나이를 출력
SELECT COUNT(*), AVG(balance), AVG(age) FROM users;
--
select
    (select count(*) from users) as 전체인원
    (select AVG(balance) from users) as 평균연봉
    (select AVG(age) from users) as 평균나이;
```

- 단일행 서브쿼리 - UPDATE에서의 활용
```sql
UPDATE users
SET balance = (SELECT AVG(balance) FROM users);
```
```sql
select country, count(*) from users group by country;
--
select
    count(*)
from users
where country in (select country from users
where last_name = '이' and first_name = '은정');
```
```sql
SELECT first_name, last_name, age
FROM users
WHERE age = (SELECT min(age) FROM users group by last_name ORDER BY last_name);
```

```sql
SELECT first_name, last_name, age
FROM users
WHERE age = (SELECT min(age) FROM users group by last_name ORDER BY last_name);
```


## 실습
